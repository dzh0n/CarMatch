// Modal functionality for contact forms
class ModalManager {
    constructor() {
        this.policyAccepted = false;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupFormValidation();
    }

    setupEventListeners() {
        // Close modal when clicking close button
        document.addEventListener('click', (e) => {
            if (e.target.closest('.close_btn')) {
                this.closeModal();
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal') && e.target.classList.contains('active')) {
                this.closeModal();
            }
        });

        // Policy checkbox toggle
        document.addEventListener('click', (e) => {
            if (e.target.closest('.checked')) {
                this.togglePolicy();
            }
        });

        // Form submission
        const form = document.querySelector('.modal_inputs');
        if (form) {
            form.addEventListener('submit', (e) => this.handleFormSubmit(e));
        }
    }

    setupFormValidation() {
        // Add required attributes and setup validation
        const modal = document.querySelector('.modal.booking');
        if (!modal) return;

        // Add hidden fields if they don't exist
        if (!modal.querySelector('input[name="car"]')) {
            const carInput = document.createElement('input');
            carInput.type = 'hidden';
            carInput.name = 'car';
            modal.querySelector('.modal_inputs').appendChild(carInput);
        }

        if (!modal.querySelector('input[name="action"]')) {
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            modal.querySelector('.modal_inputs').appendChild(actionInput);
        }

        // Add error containers if they don't exist
        const inputs = modal.querySelectorAll('input[type="text"]');
        inputs.forEach(input => {
            if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('error')) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.style.color = 'red';
                errorDiv.style.fontSize = '14px';
                errorDiv.style.marginTop = '5px';
                input.parentNode.insertBefore(errorDiv, input.nextSibling);
            }
        });
    }

    closeModal() {
        const modal = document.querySelector('.modal.booking');
        if (modal) {
            modal.classList.remove('active');
            this.clearForm();
        }
    }

    openModal(carData, action) {
        const modal = document.querySelector('.modal.booking');
        if (!modal) {
            console.error('Modal not found');
            return;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ü–µ–ª—å Yandex.Metrika –æ–± –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        if (typeof ym !== 'undefined') {
            ym(103768419, 'reachGoal', 'modal_open');
            console.log('üìä Yandex.Metrika: modal_open');
        }

        // Set car data
        const carInput = modal.querySelector('input[name="car"]');
        if (carInput) {
            carInput.value = carData;
        }

        // Set action type
        const actionInput = modal.querySelector('input[name="action"]');
        if (actionInput) {
            actionInput.value = action;
        }

        // Update modal title based on action
        const title = modal.querySelector('.modal_inner h3');
        if (title) {
            if (action === 'want') {
                title.textContent = '–•–æ—á—É —ç—Ç–æ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—å';
            } else if (action === 'discuss') {
                title.textContent = '–û–±—Å—É–¥–∏—Ç—å —Å —ç–∫—Å–ø–µ—Ä—Ç–æ–º';
            } else {
                title.textContent = '–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏';
            }
        }

        // Show modal
        modal.classList.add('active');
        
        // Clear any previous form data
        this.clearForm();
        
        // Reset policy checkbox
        this.policyAccepted = false;
        const policyCheck = document.querySelector('.checked');
        const submitBtn = document.querySelector('.thank_btn');
        
        if (policyCheck) policyCheck.classList.remove('active');
        if (submitBtn) submitBtn.disabled = true;
    }

    togglePolicy() {
        const policyCheck = document.querySelector('.checked');
        const submitBtn = document.querySelector('.thank_btn');
        
        this.policyAccepted = !this.policyAccepted;
        
        if (this.policyAccepted) {
            policyCheck.classList.add('active');
            if (submitBtn) submitBtn.disabled = false;
        } else {
            policyCheck.classList.remove('active');
            if (submitBtn) submitBtn.disabled = true;
        }
        
        this.clearError('policyError');
    }

    validateForm(formData) {
        let isValid = true;
        
        // Clear previous errors
        this.clearAllErrors();
        
        // Validate name
        const name = formData.get('name');
        if (!name || !name.trim()) {
            this.showError('nameError', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è');
            isValid = false;
        }
        
        // Validate email
        const email = formData.get('mail');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email || !email.trim()) {
            this.showError('mailError', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ email');
            isValid = false;
        } else if (!emailRegex.test(email.trim())) {
            this.showError('mailError', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email');
            isValid = false;
        }
        
        // Validate phone
        const phone = formData.get('number');
        const phoneRegex = /^[\+]?[0-9\s\-\(\)]{10,}$/;
        if (!phone || !phone.trim()) {
            this.showError('numberError', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω');
            isValid = false;
        } else if (!phoneRegex.test(phone.trim())) {
            this.showError('numberError', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            isValid = false;
        }
        
        // Validate policy
        if (!this.policyAccepted) {
            this.showError('policyError', '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è —Å–æ–≥–ª–∞—à–µ–Ω–∏—è');
            isValid = false;
        }
        
        return isValid;
    }

    showError(inputName, message) {
        const input = document.querySelector(`input[name="${inputName}"]`);
        if (input && input.nextElementSibling && input.nextElementSibling.classList.contains('error')) {
            input.nextElementSibling.textContent = message;
        }
    }

    clearError(inputName) {
        const input = document.querySelector(`input[name="${inputName}"]`);
        if (input && input.nextElementSibling && input.nextElementSibling.classList.contains('error')) {
            input.nextElementSibling.textContent = '';
        }
    }

    clearAllErrors() {
        const errors = document.querySelectorAll('.modal .error');
        errors.forEach(error => error.textContent = '');
    }

    clearForm() {
        const form = document.querySelector('.modal_inputs');
        if (form) {
            const inputs = form.querySelectorAll('input[type="text"]');
            inputs.forEach(input => input.value = '');
            
            this.policyAccepted = false;
            const policyCheck = document.querySelector('.checked');
            if (policyCheck) policyCheck.classList.remove('active');
            
            const submitBtn = document.querySelector('.thank_btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
            
            this.clearAllErrors();
        }
    }

    async handleFormSubmit(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        
        if (!this.validateForm(formData)) {
            return;
        }
        
        const submitBtn = document.querySelector('.thank_btn');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
        }
        
        try {
            // Convert FormData to regular object for JSON
            const data = {
                name: formData.get('name'),
                email: formData.get('mail'),
                phone: formData.get('number'),
                car: formData.get('car'),
                action: formData.get('action'),
                timestamp: new Date().toISOString()
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º ID —á–∞—Ç–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (window.carMatchChat && window.carMatchChat.conversationId) {
                data.conversation_id = window.carMatchChat.conversationId;
                console.log('‚úÖ Added conversation_id to form submission:', data.conversation_id);
            } else {
                console.warn('‚ö†Ô∏è No conversation_id available for form submission');
            }
            
            const response = await fetch('/api/v1/contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ü–µ–ª—å Yandex.Metrika –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã
                if (typeof ym !== 'undefined') {
                    ym(103768419, 'reachGoal', 'form_submit_success');
                    console.log('üìä Yandex.Metrika: form_submit_success');
                }
                
                this.showSuccess('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.');
                setTimeout(() => {
                    this.closeModal();
                }, 2000);
            } else {
                throw new Error('Network response was not ok');
            }
            
        } catch (error) {
            console.error('Error:', error);
            this.showError('nameError', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        } finally {
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
        }
    }

    showSuccess(message) {
        // Create or find success element
        let successEl = document.querySelector('.modal .success');
        if (!successEl) {
            successEl = document.createElement('div');
            successEl.className = 'success';
            successEl.style.color = 'green';
            successEl.style.fontSize = '14px';
            successEl.style.marginTop = '10px';
            successEl.style.textAlign = 'center';
            
            const submitBtn = document.querySelector('.thank_btn');
            if (submitBtn) {
                submitBtn.parentNode.insertBefore(successEl, submitBtn.nextSibling);
            }
        }
        successEl.textContent = message;
    }
}

// Initialize modal manager when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.modalManager = new ModalManager();
});

// Global function for easy access
window.openContactModal = function(carData, action) {
    if (window.modalManager) {
        window.modalManager.openModal(carData, action);
    } else {
        console.error('Modal manager not initialized');
    }
};
